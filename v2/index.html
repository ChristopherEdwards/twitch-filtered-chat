<!DOCTYPE xhtml>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Filtered Chat</title>
  <meta charset="utf-8" />
  <link href="assets/settings_white.png" rel="shortcut icon" type="image/png" />
  <link href="main.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="assets/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="config.js"></script>
  <script type="text/javascript" src="filtered-chat.js"></script>
  <script type="text/javascript">
"use strict";

/** QUERY STRING USAGE
 *
 * The following are handled here in index.html:
 *  layout      - Layout to use, explained below
 *
 * The following are handled in filtered-chat.js:
 *  config_key  - Config key override (default: "config")
 *  clientid    - ClientID to use for Twitch asset loading
 *  user        - Username to use (for Twitch identification)
 *  pass        - OAuth token to use (removed once parsed)
 *  debug       - One of "true", "false", "debug", "trace" (default: "false")
 *  channels    - Channels to join (without #), separated by commas
 *  noassets    - Prevents loading of image (badge, emote, cheer) assets
 *
 * The following are handled by the client:
 *  NoFFZ       - Disables FFZ support entirely
 *  NoBTTV      - Disables BTTV support entirely
 *
 * EXAMPLE QUERY STRING USAGE
 *
 * Authenticated: index.html
      ?clientid=<YOUR-CLIENTID>
      &channels=dwangoAC,pangaeapanga
      &user=<YOUR-TWITCH-USERNAME>
      &pass=oauth:<YOUR-OAUTH>
      &layout=single:chat
 * Unauthenticated: index.html
      ?channels=dwangoAC,pangaeapanga
      &layout=double:nochat
 */

/** Layout option
 *
 * Usage:
 *  layout=<keyword>[:<chat>]
 *    <keyword>  ::= "single", "double"
 *    <chat>     ::= "", "chat", "nochat"
 * Default: layout=double:chat
 *  Two columns, each with a content window. Chat is on second column.
 * Keywords:
 *  layout=single
 *    Only give one large window
 *  layout=double
 *    Give two windows side-by-side
 *  layout=single:nochat
 *    Give one large window without a chat input textarea
 *  layout=double:nochat
 *    Give two windows side-by-side without a chat input textarea
 */

const IS_OBS = window.hasOwnProperty('obsstudio') || !!window.obsstudio;

function ParseLayout(str) {
  let layout = {Cols: null, Chat: true};
  if (str.indexOf(':') > -1) {
    let opt = str.substr(str.indexOf(':')+1);
    str = str.substr(0, str.indexOf(':'));
    if (opt == "nochat") {
      layout.Chat = false;
    } else if (opt != "chat") {
      console.warn('Unknown layout option', opt);
    }
  }
  if (str == "single") {
    layout.Cols = "single";
  } else if (str == "double") {
    layout.Cols = "double";
  } else {
    console.warn("Unknown layout", str, "defaulting to double");
    layout.Cols = "double";
  }
  return layout;
}

function AssetLoaded(asset) {
  return (function() {
    var loaded = false;
    try {
      if (eval(asset).API_Loaded) {
        loaded = true;
      }
    }
    catch (e) { }
    return loaded;
  });
}

let ASSETS = [
  ["twitch-api", "utility.js", AssetLoaded('Util')],
  ["twitch-api", "twitch-utility.js", AssetLoaded('Twitch')],
  ["twitch-api", "colors.js", AssetLoaded('AllColors')],
  ["twitch-api", "client.js", AssetLoaded('TwitchClient')]
];

function AreAllAssetsLoaded() {
  for (let [lib, asset, func] of ASSETS) {
    if (!func()) {
      return false;
    } else {
      console.log(lib, asset, func, "loaded");
    }
  }
  return true;
}

/* Waits for cond to be true, then calls callback */
function wait_for_load(cond, callback) {
  if (cond()) {
    callback();
  } else {
    window.setTimeout(wait_for_load, 100);
  }
}

/* Function to generate a window */
function make_window(id, classname, name) {
  var $S = $(`
<div class="settings">
  <p>Include:</p>
  <ul class="include">
    <li><label><input type="checkbox" class="pleb" checked />Non-subs</label></li>
    <li><label><input type="checkbox" class="sub" checked />Subscribers</label></li>
    <li><label><input type="checkbox" class="vip" checked />VIPs</label></li>
    <li><label><input type="checkbox" class="mod" checked />Moderators</label></li>
    <li><label><input type="checkbox" class="event" checked />Channel events</label></li>
    <li><label><input type="checkbox" class="bits" checked />Bit messages</label></li>
    <li class="textbox include_user"><label>From user:</label><input type="text" class="user" /></li>
    <li class="textbox include_keyword"><label>Contains:</label><input type="text" class="keyword" /></li>
  </ul>
  <p>Exclude:</p>
  <ul>
    <li class="textbox exclude_user"><label>From user:</label><input type="text" class="user" /></li>
    <li class="textbox exclude_startswith"><label>Starts with:</label><input type="text" class="keyword" /></li>
  </ul>
</div>
  `);
  var $C = $(`
<span class="clch">
  <a class="clch_link" href="javascript:void(0)" title="Clear" alt="Clear">
    <img class="clch_ico" src="assets/no-entry.svg" />
  </a>
</span>
  `);
  var $d = $(document.createElement("div"));
  $d.addClass("module").addClass(classname).attr("id", id);
  var $h = $(document.createElement("div"));
  $h.addClass("header");
  $h.append($(`<div class="menu"><div></div><div></div><div></div></div>`));
  $h.append($S);
  var $l = $(document.createElement("label"));
  var $i = $(document.createElement("input"));
  $l.addClass("name").val(name);
  $i.attr("type", "text").addClass("name").attr("value", name);
  $h.append($l);
  $h.append($i);
  $d.append($h);
  $d.append($C);
  $d.append($(`<div class="content"></div>`));
  return $d;
}

/* Populate script assets */
(function() {
  function script(src) {
    return $(document.createElement('script'))
      .attr("type", "text/javascript")
      .attr("src", src)[0];
  }
  for (let [atyp, afile, afunc] of ASSETS) {
    let twapi = "https://kaedenn.github.io/twitch-api";
    if (window.location.protocol === 'file:') {
      twapi = "../../twitch-api";
    }
    let s = script(`${twapi}/${afile}`);
    if (s === null) {
      console.error("Failed to add script", asset);
    } else {
      console.log("Appending script", s);
      document.head.appendChild(s);
    }
  }
})();

/* Focus on the textarea */
$(function() {
  $("#txtChat").focus();
});

/* Populate templates and load the client */
function index_main(layout) {
  /* Populate the page with the modules */
  let modules = [];
  if (layout.Cols == "single") {
    modules.push(make_window("module1", "full", "Chat"));
  } else if (layout.Cols == "double") {
    modules.push(make_window("module1", "left", "Left Chat"));
    modules.push(make_window("module2", "right", "Right Chat"));
  }
  let $Chat = $(`<div id="chat"><textarea id="txtChat" placeholder="Send a message"></textarea></div>`);
  if (layout.Chat) {
    $(modules[modules.length-1]).find('.content').after($($Chat));
  }
  if (modules.length == 1) {
    /* Add a single column */
    let $Col = $(`<div class="column full"></div>`);
    $Col.append(modules[0]);
    $("div#wrapper").append($Col);
  } else {
    /* Add both columns */
    let $Col1 = $(`<div class="column left"></div>`);
    $Col1.append(modules[0]);
    let $Col2 = $(`<div class="column right"></div>`);
    $Col2.append(modules[1]);
    $Col1.after($Col2);
    $("div#wrapper").append($Col1);
  }
  console.log($("div#wrapper"));


  /* Templating: add settings and clear link to each module */
  var $S = $(`
<div class="settings">
  <p>Include:</p>
  <ul class="include">
    <li><label><input type="checkbox" class="pleb" checked />Non-subs</label></li>
    <li><label><input type="checkbox" class="sub" checked />Subscribers</label></li>
    <li><label><input type="checkbox" class="vip" checked />VIPs</label></li>
    <li><label><input type="checkbox" class="mod" checked />Moderators</label></li>
    <li><label><input type="checkbox" class="event" checked />Channel events</label></li>
    <li><label><input type="checkbox" class="bits" checked />Bit messages</label></li>
    <li class="textbox include_user"><label>From user:</label><input type="text" class="user" /></li>
    <li class="textbox include_keyword"><label>Contains:</label><input type="text" class="keyword" /></li>
  </ul>
  <p>Exclude:</p>
  <ul>
    <li class="textbox exclude_user"><label>From user:</label><input type="text" class="user" /></li>
    <li class="textbox exclude_startswith"><label>Starts with:</label><input type="text" class="keyword" /></li>
  </ul>
</div>
  `);

  var $C = $(`
<span class="clch">
  <a class="clch_link" href="javascript:void(0)" title="Clear" alt="Clear">
    <img class="clch_ico" src="assets/no-entry.svg" />
  </a>
</span>
  `);

  $(".module .header .menu").after($C);
  $(".module .header").after($S);

  /* Once rerendering is complete, start up the client */
  $(document).ready(client_main);
}

$(document).ready(function() {
  /* Wait until everything is loaded */
  let layout = {};
  /* Get layout information from the query string */
  let qs = document.location.search.substr(1).split('&').map((v) => v.split('='));
  qs = qs.map(([k, v]) => [k, (!!v ? decodeURIComponent(v) : null)]);
  for (let [k, v] of qs) {
    if (k === "layout") {
      layout = ParseLayout(v);
    }
  }
  wait_for_load(AreAllAssetsLoaded, function() { index_main(layout); });
});
  </script>
</head>
<body>
  <!-- Beginning of content -->
  <div id="wrapper">
  </div>
  <!-- End of content -->
  <!-- Beginning of settings -->
  <div id="settings">
    <header>Settings</header>
    <ul>
      <li>
        <label>Channels:</label>
        <input type="text" id="txtChannel" />
      </li>
      <li>
        <label>Nick:</label>
        <input type="text" id="txtNick" />
      </li>
      <li>
        <label>ClientID:</label>
        <input type="text" id="txtClientID" />
      </li>
      <li>
        <label>OAuth:</label>
        <input type="password" id="txtPass" />
        <input type="text" id="txtPassDummy" value="Cached" style="display: none" disabled />
      </li>
      <li>
        <label>Debugging:</label>
        <select id="selDebug">
          <option disabled>Select...</option>
          <option value="0">Disabled</option>
          <option value="1">Debug</option>
          <option value="2">Trace</option>
        </select>
      </li>
      <li>
        <label>No Force:</label>
        <input type="checkbox" id="cbForce" />
      </li>
    </ul>
    <footer>
      <span class="fl"><a onclick="$('#settings_button').click();">Close</a></span>
      <span class="fr" id="reconnect"><a>Reconnect</a></span>
    </footer>
  </div>
  <img id="settings_button" src="assets/settings_white.png" alt="Settings" />
  <!-- End of settings -->
  <!-- Beginning of nickname context window -->
  <div id="username_context" class="username_context">

  </div>
  <!-- End of nickname context window -->
</body>
</html>
